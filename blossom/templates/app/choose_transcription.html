{% extends "website/partials/base.partial" %}
{% load humanize %}


{% block content %}
    <style>
        /* https://stackoverflow.com/a/61931093 */
        .fade-out {
            animation: fade 0.3s;
            -webkit-animation: fade 0.3s;
            -moz-animation: fade 0.3s;
        }

        /* Animate opacity */
        @keyframes fade {
            from {
                opacity: 1
            }
            to {
                opacity: 0
            }
        }

        @-moz-keyframes fade {
            from {
                opacity: 1
            }
            to {
                opacity: 0
            }
        }

        @-webkit-keyframes fade {
            from {
                opacity: 1
            }
            to {
                opacity: 0
            }
        }

    </style>

    <h1>Choose Post to Transcribe</h1>

    {% if messages %}
        {% for message in messages %}
            {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                <div class="alert alert-danger text-center" role="alert">
                    {{ message }}
                </div>
            {% else %}
                <div class="alert alert-success text-center" role="alert">
                    {{ message }}
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="mt-3">
        Pick one of the {{ options|length|apnumber }} options below to get started!
    </div>
    <div class="container">
        <div class="row">
            {% for option in options %}
                <div class="col-xl-4">
                    <div class="card mt-4 shadow" style="width: 100%">
                        <div class="card-body">
                            <h5 class="card-title">{{ option.title }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">
                                {{ option.get_subreddit_name }}, posted {{ option.create_time|naturaltime }}
                            </h6>
                            <div class="card-text">
                                <div class="position-relative">
                                    <img
                                            src="{{ option.content_url }}"
                                            class="rounded"
                                            alt="The content image that should be transcribed."
                                            style="z-index: 0;width: 100%;"
                                    >
                                    {% if option.nsfw %}
                                        <div style="z-index: 1; width: 100%; height:100%;"
                                             class="position-absolute top-0 bg-danger rounded"></div>
                                        <button class="nsfwButton btn btn-danger position-absolute translate-middle top-50 start-50"
                                                style="z-index: 2; border-color: white"
                                                onclick="showNSFW(this)"
                                        >View
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-0 col-sm-3"></div>
                                <div class="col-12 col-sm-6">
                                    <div class="d-grid gap-2">
                                        <a href="{% url 'choose_transcription' %}" type="submit"
                                           class="btn btn-success">Transcribe!</a>
                                    </div>
                                </div>
                                <div class="col-0 col-sm-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="text-muted mt-4 text-center">Don't like these options? Just reroll!</div>
    <div class="row mt-3 mb-5">
        <div class="col-0 col-sm-3"></div>
        <div class="col-12 col-sm-6">
            <div class="d-grid gap-2">
                <a href="{% url 'choose_transcription' %}" class="btn btn-outline-primary">Reroll!</a>
            </div>
        </div>
        <div class="col-0 col-sm-3"></div>
    </div>
{% endblock %}

{% block scripts %}
    {% if show_confetti %}
        <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
        <script type="application/javascript">
            var count = 400;
            var defaults = {
                origin: {y: 0.7}
            };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }

            fire(0.25, {
                spread: 26,
                startVelocity: 55,
            });
            fire(0.2, {
                spread: 60,
            });
            fire(0.35, {
                spread: 100,
                decay: 0.91,
                scalar: 0.8
            });
            fire(0.1, {
                spread: 120,
                startVelocity: 25,
                decay: 0.92,
                scalar: 1.2
            });
            fire(0.1, {
                spread: 120,
                startVelocity: 45,
            });
        </script>
    {% endif %}

    <script type="application/javascript">

        function showNSFW(el) {
            el.previousElementSibling.onanimationend = (e) => {
                if (e.target.classList.contains('fade-out')) {
                    el.parentNode.removeChild(el.previousElementSibling);
                }
            };
            el.onanimationend = (e) => {
                if (e.target.classList.contains('fade-out')) {
                    el.parentNode.removeChild(el);
                }
            };
            el.previousElementSibling.classList.add('fade-out');
            el.classList.add('fade-out');
        }

        // https://stackoverflow.com/a/50748630
        const params = decodeURI(window.location.search)
            .replace('?', '')
            .split('&')
            .map(param => param.split('='))
            .reduce((values, [key, value]) => {
                values[key] = value
                return values
            }, {})

        document.addEventListener("DOMContentLoaded", function () {
            if (params['show_tutorial'] === '1') {
                document.getElementById('tutorialToggleButton').click()
            }
        });
    </script>
{% endblock %}
